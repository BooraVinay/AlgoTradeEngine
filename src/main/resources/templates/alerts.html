<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:lang="${#locale}">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Today's Alerts</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSRF meta tags (optional if Spring Security) -->
    <meta name="_csrf" th:content="${_csrf.token}" th:if="${_csrf != null}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}" th:if="${_csrf != null}"/>
    <meta name="_csrf_param" th:content="${_csrf.parameterName}" th:if="${_csrf != null}"/>

    <style>
        /* Toast */
        #toast { position: fixed; top:1rem; right:1rem; background:#10b981; color:#fff; padding:.8rem 1rem; border-radius:.5rem; display:none; z-index:9999; box-shadow:0 8px 20px rgba(16,185,129,0.12); }
        tbody tr.accepted td { background:#d1fae5 !important; }
        tbody tr.rejected td { background:#fee2e2 !important; }
        tbody tr.failed td { background:#ffe4e6 !important; }
        tbody tr.new-alert td { background:#fef3c7 !important; }
        .disabled-btn { opacity:.6; cursor:not-allowed; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-blue-600 text-white py-4">
    <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
        <div class="text-xl font-bold">TradeApp</div>
        <nav class="space-x-4 text-sm flex items-center">
            <a href="/dashboard" class="hover:underline">Dashboard</a>
            <a href="/account-info" class="hover:underline">Account Info</a>
            <a href="/portfolio" class="hover:underline">View Portfolio</a>
            <a href="/place-order" class="hover:underline">Place Order</a>
            <a href="/trading-history" class="hover:underline">Trading History</a>
            <a href="/trade-book" class="hover:underline">Trade Book</a>
            <a href="/alerts/today" class="hover:underline">Alerts</a>
            <a href="/scrip/search" class="hover:underline">Search Scrip</a>
            <a href="/auth/logout" class="hover:underline">Logout</a>
        </nav>
    </div>
</header>

<main class="py-12">
    <div class="max-w-6xl mx-auto px-4">

        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-semibold">Today's Alerts</h2>

            <div class="flex items-center gap-3">
                <div class="text-sm text-gray-700 mr-2">
                    <strong th:text="${'Unprocessed: ' + #lists.size(alerts.?[status eq 'NEW'])}">Unprocessed: 0</strong>
                </div>

                <!-- Time filter -->
                <select id="timeFilter" class="px-3 py-1 rounded border">
                    <option value="today" selected>Today</option>
                    <option value="7days">Last 7 days</option>
                    <option value="all">All</option>
                </select>

                <!-- Status filter -->
                <select id="statusFilter" class="px-3 py-1 rounded border">
                    <option value="ALL" selected>All</option>
                    <option value="NEW">NEW</option>
                    <option value="ACCEPTED">ACCEPTED</option>
                    <option value="REJECTED">REJECTED</option>
                    <option value="FAILED">FAILED</option>
                </select>

                <!-- Stop / Resume Alerts -->
                <button id="stopAlertsBtn"
                        type="button"
                        th:classappend="${stopAlerts} ? 'bg-gray-500' : 'bg-red-600'"
                        th:data-stop="${stopAlerts} ? 'true' : 'false'"
                        th:text="${stopAlerts} ? 'Resume Alerts' : 'Stop Alerts'"
                        class="px-3 py-1 text-white rounded hover:opacity-90">
                    Stop Alerts
                </button>

                <a id="tradingHistoryLink" href="/trading-history" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Trading History</a>
            </div>
        </div>

        <!-- flash messages -->
        <div th:if="${message}" class="mb-4">
            <div class="bg-blue-100 text-blue-700 p-3 rounded" th:text="${message}"></div>
        </div>
        <div th:if="${orderError}" class="mb-4">
            <div class="bg-red-100 text-red-700 p-3 rounded" th:text="${orderError}"></div>
        </div>
        <div th:if="${orderResult}" class="mb-4">
            <div class="bg-green-100 text-green-700 p-3 rounded" th:text="${orderResult}"></div>
        </div>

        <!-- alerts table -->
        <div class="bg-white rounded shadow p-4 overflow-x-auto">
            <table class="min-w-full table-auto">
                <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 text-left">Ticker</th>
                    <th class="px-4 py-2 text-left">Exchange</th>
                    <th class="px-4 py-2 text-left">Action</th>
                    <th class="px-4 py-2 text-left">Qty</th>
                    <th class="px-4 py-2 text-left">Status</th>
                    <th class="px-4 py-2 text-left">Time</th>
                    <th class="px-4 py-2 text-left">Operations</th>
                </tr>
                </thead>
                <tbody id="alertsTableBody">
                <tr th:each="alert : ${alerts}"
                    th:attr="data-status=${alert.status},data-time=${alert.time}"
                    th:classappend="${alert.status eq 'NEW'} ? 'new-alert' : (alert.status eq 'ACCEPTED' ? 'accepted' : (alert.status eq 'REJECTED' ? 'rejected' : (alert.status eq 'FAILED' ? 'failed' : '')) )">
                    <td class="px-4 py-2" th:text="${alert.ticker}">-</td>
                    <td class="px-4 py-2" th:text="${alert.exchange}">-</td>
                    <td class="px-4 py-2" th:text="${alert.action}">-</td>
                    <td class="px-4 py-2" th:text="${alert.quantity}">-</td>
                    <td class="px-4 py-2 status-cell" th:text="${alert.status}">-</td>
                    <td class="px-4 py-2" th:text="${alert.time}">-</td>
                    <td class="px-4 py-2">
                        <form th:action="@{/alerts/{id}/accept(id=${alert.id})}" method="post" class="inline accept-form">
                            <div th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            </div>
                            <button type="submit"
                                    class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 accept-btn"
                                    th:disabled="${alert.status ne 'NEW'}">Accept</button>
                        </form>

                        <form th:action="@{/alerts/{id}/reject(id=${alert.id})}" method="post" class="inline ml-2 reject-form">
                            <div th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            </div>
                            <button type="submit"
                                    class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 reject-btn"
                                    th:disabled="${alert.status ne 'NEW'}">Reject</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>

            <div th:if="${#lists.isEmpty(alerts)}" class="text-gray-500 p-4">No alerts for today.</div>
        </div>

    </div>
</main>

<!-- toast -->
<div id="toast" role="status" aria-live="polite">Action performed</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // read CSRF meta (optional)
    function readCsrfFromMeta() {
        var tokenMeta = document.querySelector('meta[name="_csrf"]');
        var headerMeta = document.querySelector('meta[name="_csrf_header"]');
        var paramMeta = document.querySelector('meta[name="_csrf_param"]');
        return {
            token: tokenMeta ? tokenMeta.getAttribute('content') : '',
            header: headerMeta ? headerMeta.getAttribute('content') : 'X-CSRF-TOKEN',
            param: paramMeta ? paramMeta.getAttribute('content') : '_csrf'
        };
    }
    var csrf = readCsrfFromMeta();

    var stopBtn = document.getElementById('stopAlertsBtn');
    var stopAlerts = stopBtn ? (stopBtn.getAttribute('data-stop') === 'true') : false;

    function showToast(message) {
        var t = document.getElementById('toast');
        if (!t) return;
        t.textContent = message;
        t.style.display = 'block';
        t.style.opacity = '1';
        setTimeout(function () {
            t.style.transition = 'opacity 400ms';
            t.style.opacity = '0';
            setTimeout(function () { t.style.display = 'none'; }, 450);
        }, 1600);
    }

    // Toggle stop/resume alerts
    if (stopBtn) {
        stopBtn.addEventListener('click', function () {
            var headers = {};
            if (csrf.token) headers[csrf.header] = csrf.token;
            fetch('/alerts/ajax/toggle', {
                method: 'POST',
                credentials: 'same-origin',
                headers: headers
            })
                .then(function (r) { return r.ok ? r.json() : Promise.reject(); })
                .then(function (data) {
                    stopAlerts = !!data.stopAlerts;
                    stopBtn.textContent = stopAlerts ? 'Resume Alerts' : 'Stop Alerts';
                    stopBtn.setAttribute('data-stop', stopAlerts ? 'true' : 'false');
                    if (stopAlerts) { stopBtn.classList.remove('bg-red-600'); stopBtn.classList.add('bg-gray-500'); }
                    else { stopBtn.classList.remove('bg-gray-500'); stopBtn.classList.add('bg-red-600'); }
                    showToast(stopAlerts ? 'Alerts paused' : 'Alerts resumed');
                })
                .catch(function () { showToast('Failed toggling alerts'); });
        });
    }

    // Instant UI update when Accept/Reject clicked: disable buttons, change status cell & row color
    function markRowState(tr, newState) {
        tr.classList.remove('new-alert','accepted','rejected','failed');
        if (newState === 'ACCEPTED') tr.classList.add('accepted');
        else if (newState === 'REJECTED') tr.classList.add('rejected');
        else if (newState === 'FAILED') tr.classList.add('failed');

        var statusCell = tr.querySelector('.status-cell');
        if (statusCell) statusCell.textContent = newState;
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Attach to forms: update UI immediately on submit
        document.querySelectorAll('.accept-form').forEach(function (form) {
            form.addEventListener('submit', function () {
                var btn = form.querySelector('.accept-btn');
                if (btn) { btn.disabled = true; btn.classList.add('disabled-btn'); }
                var sibling = form.parentElement.querySelector('.reject-btn');
                if (sibling) { sibling.disabled = true; sibling.classList.add('disabled-btn'); }

                // mark row accepted immediately
                var tr = form.closest('tr');
                if (tr) markRowState(tr, 'ACCEPTED');

                showToast('Accept submitted — processing...');
                // allow normal form submit
            });
        });

        document.querySelectorAll('.reject-form').forEach(function (form) {
            form.addEventListener('submit', function () {
                var btn = form.querySelector('.reject-btn');
                if (btn) { btn.disabled = true; btn.classList.add('disabled-btn'); }
                var sibling = form.parentElement.querySelector('.accept-btn');
                if (sibling) { sibling.disabled = true; sibling.classList.add('disabled-btn'); }

                // mark row rejected immediately
                var tr = form.closest('tr');
                if (tr) markRowState(tr, 'REJECTED');

                showToast('Reject submitted.');
                // allow normal submit
            });
        });

        // Filters wiring
        var timeFilter = document.getElementById('timeFilter');
        var statusFilter = document.getElementById('statusFilter');
        function applyFilters() {
            var timeSel = timeFilter.value;
            var statusSel = statusFilter.value;
            var rows = document.querySelectorAll('#alertsTableBody tr');
            var now = new Date();

            rows.forEach(function (r) {
                var state = (r.getAttribute('data-status') || '').toUpperCase();
                var tStr = r.getAttribute('data-time') || r.querySelector('td:nth-child(6)').textContent || '';
                var show = true;

                // status filter
                if (statusSel !== 'ALL' && state !== statusSel) show = false;

                // time filter
                if (show && timeSel !== 'all') {
                    var rowDate = parseDateSafe(tStr);
                    if (!rowDate) {
                        // If we can't parse date, keep it visible in 'all' only:
                        show = (timeSel === 'all');
                    } else {
                        var diffMs = now - rowDate;
                        var diffDays = diffMs / (1000 * 60 * 60 * 24);
                        if (timeSel === 'today' && (rowDate.getDate() !== now.getDate() || rowDate.getMonth() !== now.getMonth() || rowDate.getFullYear() !== now.getFullYear())) {
                            show = false;
                        } else if (timeSel === '7days' && diffDays > 7) {
                            show = false;
                        }
                    }
                }

                r.style.display = show ? '' : 'none';
            });
        }

        timeFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);

        // apply default filter (Today)
        applyFilters();
    });

    // polling for new alerts (respects stopAlerts)
    (function pollNewAlerts() {
        if (!stopAlerts) {
            fetch('/alerts/new', { credentials: 'same-origin' })
                .then(function (r) { return r.ok ? r.json() : []; })
                .then(function (data) {
                    if (Array.isArray(data) && data.length > 0) {
                        var tbody = document.getElementById('alertsTableBody');
                        data.forEach(function (alert) {
                            var tr = document.createElement('tr');
                            tr.className = 'new-alert';
                            // add attributes used by filters
                            tr.setAttribute('data-status', alert.status || 'NEW');
                            tr.setAttribute('data-time', alert.time || '');
                            tr.innerHTML =
                                '<td class="px-4 py-2">' + escapeHtml(alert.ticker) + '</td>' +
                                '<td class="px-4 py-2">' + escapeHtml(alert.exchange) + '</td>' +
                                '<td class="px-4 py-2">' + escapeHtml(alert.action) + '</td>' +
                                '<td class="px-4 py-2">' + escapeHtml(String(alert.quantity)) + '</td>' +
                                '<td class="px-4 py-2 status-cell">' + escapeHtml(alert.status || 'NEW') + '</td>' +
                                '<td class="px-4 py-2">' + escapeHtml(alert.time || '') + '</td>' +
                                '<td class="px-4 py-2">' +
                                '<form action="/alerts/' + encodeURIComponent(alert.id) + '/accept" method="post" class="inline accept-form">' +
                                (csrf.token ? '<input type="hidden" name="' + csrf.param + '" value="' + csrf.token + '"/>' : '') +
                                '<button type="submit" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Accept</button>' +
                                '</form>' +
                                '<form action="/alerts/' + encodeURIComponent(alert.id) + '/reject" method="post" class="inline ml-2 reject-form">' +
                                (csrf.token ? '<input type="hidden" name="' + csrf.param + '" value="' + csrf.token + '"/>' : '') +
                                '<button type="submit" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Reject</button>' +
                                '</form>' +
                                '</td>';
                            if (tbody.firstChild) tbody.insertBefore(tr, tbody.firstChild); else tbody.appendChild(tr);
                        });
                        showToast('New alert(s): ' + data.map(function(a){ return a.ticker; }).join(', '));
                        // re-apply filters so newly inserted rows are filtered accordingly
                        document.getElementById('timeFilter').dispatchEvent(new Event('change'));
                        document.getElementById('statusFilter').dispatchEvent(new Event('change'));
                    }
                    setTimeout(pollNewAlerts, 3000);
                })
                .catch(function () { setTimeout(pollNewAlerts, 3000); });
        } else {
            setTimeout(pollNewAlerts, 3000);
        }
    })();

    // safe date parse: try multiple formats; if fails return null
    function parseDateSafe(s) {
        if (!s) return null;
        // try ISO first
        var d = new Date(s);
        if (!isNaN(d.getTime())) return d;
        // try replacing space with T
        d = new Date(s.replace(' ', 'T'));
        if (!isNaN(d.getTime())) return d;
        // try timestamp number
        var n = Number(s);
        if (!isNaN(n)) return new Date(n);
        return null;
    }

    function escapeHtml(s) {
        if (s === null || s === undefined) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
    /*]]>*/
</script>

</body>
</html>
