<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Place Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
<header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
        <div class="text-xl font-bold">TradeApp</div>
        <nav class="space-x-4 text-sm">
            <a href="/dashboard" class="hover:underline">Dashboard</a>
            <a href="/account-info" class="hover:underline">Account Info</a>
            <a href="/portfolio" class="hover:underline">View Portfolio</a>
            <a href="/place-order" class="hover:underline">Place Order</a>
            <a href="/trading-history" class="hover:underline">Trading History</a>
            <a href="/trade-book" class="hover:underline">Trade Book</a>
            <a href="/alerts/today" class="hover:underline">Alerts</a>
            <a href="/scrip/search" class="hover:underline">Search Scrip</a>
            <a href="/auth/logout" class="hover:underline">Logout</a>
        </nav>
    </div>
</header>

<main class="flex-grow flex items-start justify-center p-6">
    <div class="w-full max-w-2xl bg-white shadow rounded p-6">
        <h1 class="text-2xl font-bold mb-4 text-center">Place New Order</h1>

        <form th:action="@{/place-order}" method="post" class="space-y-4">
            <div class="flex flex-wrap items-end gap-2">
                <div class="flex-1">
                    <label class="block text-sm font-medium mb-1">Trading Symbol</label>
                    <input id="tradingsymbol" type="text" name="tradingsymbol" placeholder="e.g. SBIN-EQ" required
                           th:value="${prefillSymbol}"
                           class="w-full border rounded p-2 focus:ring focus:ring-blue-200">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1 invisible">Exchange</label>
                    <select id="exchange" name="exchange" class="border rounded p-2">
                        <option value="NSE">NSE</option>
                        <option value="BSE">BSE</option>
                        <option value="NFO">NFO</option>
                        <option value="MCX">MCX</option>
                    </select>
                </div>

                <button type="button" id="validateBtn" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">
                    Validate
                </button>

                <a th:href="@{/scrip/search}" class="bg-gray-200 text-gray-800 px-3 py-2 rounded hover:bg-gray-300">
                    Search Scrip
                </a>
            </div>

            <div th:if="${prefillToken == null}" id="tokenHint"
                 class="bg-yellow-50 border-l-4 border-yellow-400 p-3 text-sm text-yellow-800 rounded">
                <strong>Note:</strong> Use <em>Validate</em> or <a th:href="@{/scrip/search}" class="underline">Search Scrip</a> to fetch the correct token.
            </div>

            <input type="hidden" id="symboltoken" name="symboltoken" th:value="${prefillToken}"/>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Transaction Type</label>
                    <select name="transactiontype" class="w-full border rounded p-2">
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Order Type</label>
                    <select name="ordertype" class="w-full border rounded p-2">
                        <option value="MARKET">MARKET</option>
                        <option value="LIMIT">LIMIT</option>
                        <option value="STOPLOSS_MARKET">SL-M</option>
                        <option value="STOPLOSS_LIMIT">SL-L</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Quantity</label>
                    <input type="number" name="quantity" min="1" value="1" class="w-full border rounded p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Price (for LIMIT orders)</label>
                    <input type="number" step="0.01" name="price" placeholder="0.0" class="w-full border rounded p-2">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">Product Type</label>
                <select name="producttype" class="w-full border rounded p-2">
                    <option value="INTRADAY">INTRADAY</option>
                    <option value="DELIVERY">DELIVERY</option>
                    <option value="MARGIN">MARGIN</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">Duration</label>
                <select name="duration" class="w-full border rounded p-2">
                    <option value="DAY">DAY</option>
                    <option value="IOC">IOC</option>
                </select>
            </div>

            <div class="pt-4 flex justify-center">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    Place Order
                </button>
            </div>
        </form>

        <div id="validateMsg" class="mt-3 text-sm text-gray-700"></div>

        <!-- order result -->
        <div class="mt-6">
            <div th:if="${orderResult}" class="bg-green-100 text-green-800 p-4 rounded shadow">
                <p class="font-semibold">✅ <span th:text="${statusMessage}">Order placed successfully!</span></p>
                <p class="mt-1">Order ID: <span th:text="${orderId}">12345</span></p>
                <div class="mt-2 text-xs text-gray-700"><pre th:text="${#strings.toString(orderResult)}"></pre></div>
            </div>

            <div th:if="${orderError}" class="bg-red-100 text-red-800 p-4 rounded shadow">
                <p class="font-semibold">❌ Order failed</p>
                <p th:text="${orderError}" class="mt-1"></p>
            </div>
        </div>
    </div>
</main>

<script>
    document.getElementById('validateBtn').addEventListener('click', async () => {
        const ticker = document.getElementById('tradingsymbol').value.trim();
        const exchange = document.getElementById('exchange').value || 'NSE';
        const msg = document.getElementById('validateMsg');
        if (!ticker) { msg.textContent = 'Enter a symbol to validate.'; return; }
        msg.textContent = 'Searching...';

        try {
            const resp = await fetch(`/api/scrip/search?ticker=${encodeURIComponent(ticker)}&exchange=${encodeURIComponent(exchange)}`);
            if (!resp.ok) throw new Error('Search failed');
            const data = await resp.json();
            if (Array.isArray(data) && data.length > 0) {
                const s = data[0];
                const token = s.symboltoken || s.symbolToken;
                document.getElementById('symboltoken').value = token;
                msg.innerHTML = `✅ Found: <strong>${s.tradingsymbol}</strong> (token ${token})`;
                document.getElementById('tokenHint')?.classList.add('hidden');
            } else {
                msg.textContent = 'No matching scrip found.';
            }
        } catch (err) {
            msg.textContent = 'Error: ' + err.message;
        }
    });
</script>
</body>
</html>
